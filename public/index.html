<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Business Card</title>
    <link href="css/style.css" rel="stylesheet">
    <!-- Add Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="min-h-screen bg-gradient-to-b from-primary to-secondary">
    <div class="min-h-screen flex flex-col">
        <!-- Main Content -->
        <main class="flex-grow flex flex-col items-center justify-center p-6 text-white">
            <!-- Profile Section -->
            <div class="w-full max-w-sm bg-white/10 backdrop-blur-lg rounded-2xl p-8 mb-8 text-center">
                <div class="w-32 h-32 mx-auto mb-6 rounded-full overflow-hidden">
                    <img id="profilePicture" alt="Profile Picture" class="w-full h-full object-cover" style="background:#e5e7eb;" />
                </div>
                <h1 class="text-2xl font-bold mb-2">John Doe</h1>
                <p class="text-lg mb-4">Full Stack Developer</p>
                <div class="flex justify-center space-x-4 mb-6">
                    <a href="#" class="text-white hover:text-gray-200">
                        <i class="fab fa-linkedin text-xl"></i>
                    </a>
                    <a href="#" class="text-white hover:text-gray-200">
                        <i class="fab fa-github text-xl"></i>
                    </a>
                    <a href="#" class="text-white hover:text-gray-200">
                        <i class="fab fa-twitter text-xl"></i>
                    </a>
                </div>
                <p class="text-sm text-white/80">
                    <i class="fas fa-envelope mr-2"></i>john.doe@example.com
                </p>
            </div>

            <!-- Action Buttons -->
            <div class="w-full max-w-sm space-y-4">
                <a href="#" class="block w-full bg-white text-primary py-4 px-6 rounded-xl font-semibold text-center hover:bg-gray-100 transition duration-300">
                    <i class="fas fa-globe mr-2"></i>Visit Website
                </a>
                <a href="#" class="block w-full bg-white/10 backdrop-blur-lg text-white py-4 px-6 rounded-xl font-semibold text-center hover:bg-white/20 transition duration-300">
                    <i class="fas fa-address-card mr-2"></i>Save Contact
                </a>
                <a href="schedule.html" class="block w-full bg-white/10 backdrop-blur-lg text-white py-4 px-6 rounded-xl font-semibold text-center hover:bg-white/20 transition duration-300">
                    <i class="fas fa-calendar-alt mr-2"></i>Schedule Meeting
                </a>
                <a href="#" class="block w-full bg-white/10 backdrop-blur-lg text-white py-4 px-6 rounded-xl font-semibold text-center hover:bg-white/20 transition duration-300">
                    <i class="fas fa-envelope mr-2"></i>Send Email
                </a>
                <button id="uploadImageBtn" class="block w-full bg-white/10 backdrop-blur-lg text-white py-4 px-6 rounded-xl font-semibold text-center hover:bg-white/20 transition duration-300">
                    <i class="fas fa-upload mr-2"></i>Upload Image
                </button>
            </div>  
        </main>

        <!-- Gallery Section -->
        <div class="w-full max-w-sm mx-auto px-6 mb-8">
            <h2 class="text-xl font-bold text-white mb-4">Gallery</h2>
            <div class="grid grid-cols-3 gap-4">
                <!-- Picture Box 1 -->
                <div class="bg-white/10 backdrop-blur-lg rounded-xl overflow-hidden aspect-square cursor-pointer hover:bg-white/20 transition duration-300" onclick="openGalleryModal(0)">
                    <img src="https://picsum.photos/300/300?random=1" alt="Gallery Image 1" class="w-full h-full object-cover" />
                </div>
                <!-- Picture Box 2 -->
                <div class="bg-white/10 backdrop-blur-lg rounded-xl overflow-hidden aspect-square cursor-pointer hover:bg-white/20 transition duration-300" onclick="openGalleryModal(1)">
                    <img src="https://picsum.photos/300/300?random=2" alt="Gallery Image 2" class="w-full h-full object-cover" />
                </div>
                <!-- Picture Box 3 -->
                <div class="bg-white/10 backdrop-blur-lg rounded-xl overflow-hidden aspect-square cursor-pointer hover:bg-white/20 transition duration-300" onclick="openGalleryModal(2)">
                    <img src="https://picsum.photos/300/300?random=3" alt="Gallery Image 3" class="w-full h-full object-cover" />
                </div>
            </div>
        </div>

        <!-- Gallery Modal -->
        <div id="galleryModal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50" style="display:none;">
            <div class="bg-white rounded-xl p-6 w-full max-w-lg mx-4">
                <div class="relative">
                    <button onclick="closeGalleryModal()" class="absolute -top-2 -right-2 bg-white rounded-full p-2 shadow-lg hover:bg-gray-100">
                        <i class="fas fa-times text-gray-600"></i>
                    </button>
                    <img id="modalImage" src="" alt="Gallery Image" class="w-full h-64 object-cover rounded-lg mb-4" />
                    <h3 id="modalTitle" class="text-xl font-bold text-gray-800 mb-2"></h3>
                    <p id="modalDescription" class="text-gray-600 mb-4"></p>
                    <div class="flex items-center text-sm text-gray-500">
                        <i class="fas fa-calendar-alt mr-2"></i>
                        <span id="modalDate"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="p-4 text-center text-white/60 text-sm">
            <p>Made with <3 by Nikko Mission</p>
        </footer>
    </div>

    <!-- Upload Image Modal -->
    <div id="uploadModal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-50" style="display:none;">
      <div class="bg-white rounded-xl p-8 w-full max-w-xs text-center">
        <h2 class="text-lg font-bold mb-4 text-primary">Upload a Picture</h2>
        <input type="text" id="modalUsernameInput" placeholder="Enter username (required)" class="mb-4 w-full px-3 py-2 border border-gray-300 rounded" required />
        <input type="file" id="modalImageInput" accept="image/*" class="mb-4 w-full" />
        <div class="flex justify-center space-x-2">
          <button id="modalUploadBtn" class="bg-primary text-white px-4 py-2 rounded hover:bg-primary/80">Upload</button>
          <button id="modalCancelBtn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400">Cancel</button>
        </div>
        <div id="modalUploadStatus" class="mt-4 text-sm"></div>
      </div>
    </div>

    <!-- Add JavaScript for contact saving -->
    <script>
        // Contact information
        const contact = {
            name: 'John Doe',
            title: 'Full Stack Developer',
            email: 'john.doe@example.com',
            phone: '+1234567890',
            company: 'Your Company',
            website: 'https://yourwebsite.com',
            linkedin: 'https://linkedin.com/in/yourprofile'
        };

        // Fetch and set profile image from database for 'John Doe'
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const response = await fetch('/api/image-by-name/John%20Doe');
                const profileImg = document.getElementById('profilePicture');
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.id) {
                        profileImg.src = `/api/image/${data.id}`;
                        return;
                    }
                }
                // If not found, clear src (show blank/placeholder)
                profileImg.removeAttribute('src');
            } catch (err) {
                // On error, clear src
                const profileImg = document.getElementById('profilePicture');
                profileImg.removeAttribute('src');
            }
        });

        // Function to save contact directly to phone contacts
        async function saveContact() {
            try {
                // Check if the Contacts API is available
                if ('contacts' in navigator && 'ContactsManager' in window) {
                    const props = ['name', 'email', 'tel', 'url', 'organization'];
                    const opts = { multiple: false };

                    try {
                        const contacts = await navigator.contacts.select(props, opts);
                        // Contact was selected, now add our contact
                        const newContact = {
                            name: [contact.name],
                            email: [{
                                address: contact.email,
                                type: 'work'
                            }],
                            tel: [{
                                number: contact.phone,
                                type: 'work'
                            }],
                            url: [{
                                url: contact.website,
                                type: 'work'
                            }],
                            organization: [contact.company]
                        };

                        // Add the contact
                        await navigator.contacts.save(newContact);
                        showToast('Contact saved successfully!');
                    } catch (err) {
                        console.error('Error saving contact:', err);
                        // Fallback to vCard if direct save fails
                        downloadVCard();
                    }
                } else {
                    // Fallback to vCard for browsers that don't support Contacts API
                    downloadVCard();
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Failed to save contact. Please try again.');
            }
        }

        // Fallback function to download vCard
        function downloadVCard() {
            try {
                const vcard = `BEGIN:VCARD
VERSION:3.0
N:${contact.name.split(' ').reverse().join(';')}
FN:${contact.name}
TITLE:${contact.title}
ORG:${contact.company}
EMAIL;type=WORK,INTERNET:${contact.email}
TEL;type=WORK,VOICE:${contact.phone}
URL:${contact.website}
URL;type=LINKEDIN:${contact.linkedin}
NOTE:Digital Business Card
END:VCARD`;

                const blob = new Blob([vcard], { type: 'text/vcard' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${contact.name}.vcf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast('Contact downloaded. Please import to your contacts.');
            } catch (error) {
                console.error('Error downloading vCard:', error);
                showToast('Failed to download contact. Please try again.');
            }
        }

        // Function to show toast message
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-black/80 text-white px-6 py-3 rounded-full text-sm';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Add click handlers
        document.addEventListener('DOMContentLoaded', function() {
            // Save Contact button
            const saveContactBtn = document.querySelector('a:has(.fa-address-card)');
            if (saveContactBtn) {
                saveContactBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    saveContact();
                    trackTap('Save Contact');
                });
            }

            // Visit Website button
            const visitWebsiteBtn = document.querySelector('a:has(.fa-globe)');
            if (visitWebsiteBtn) {
                visitWebsiteBtn.href = contact.website;
                visitWebsiteBtn.addEventListener('click', function() {
                    trackTap('Visit Website');
                });
            }

            // Send Email button
            const sendEmailBtn = document.querySelector('a:has(.fa-envelope)');
            if (sendEmailBtn) {
                sendEmailBtn.href = `mailto:${contact.email}`;
                sendEmailBtn.addEventListener('click', function() {
                    trackTap('Send Email');
                });
            }

            // Schedule Meeting button
            const scheduleMeetingBtn = document.querySelector('a:has(.fa-calendar-alt)');
            if (scheduleMeetingBtn) {
                scheduleMeetingBtn.addEventListener('click', function() {
                    trackTap('Schedule Meeting');
                });
            }

            // Upload Image button and modal logic
            const uploadImageBtn = document.getElementById('uploadImageBtn');
            const uploadModal = document.getElementById('uploadModal');
            const modalImageInput = document.getElementById('modalImageInput');
            const modalUsernameInput = document.getElementById('modalUsernameInput');
            const modalUploadBtn = document.getElementById('modalUploadBtn');
            const modalCancelBtn = document.getElementById('modalCancelBtn');
            const modalUploadStatus = document.getElementById('modalUploadStatus');

            if (uploadImageBtn && uploadModal && modalImageInput && modalUsernameInput && modalUploadBtn && modalCancelBtn) {
                uploadImageBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    uploadModal.style.display = 'flex';
                    modalImageInput.value = '';
                    modalUsernameInput.value = '';
                    modalUploadStatus.textContent = '';
                });

                modalCancelBtn.addEventListener('click', function() {
                    uploadModal.style.display = 'none';
                });

                modalUploadBtn.addEventListener('click', async function() {
                    const username = modalUsernameInput.value.trim();
                    if (!username) {
                        modalUploadStatus.textContent = 'Username is required.';
                        modalUsernameInput.focus();
                        return;
                    }
                    if (modalImageInput.files.length > 0) {
                        const formData = new FormData();
                        formData.append('image', modalImageInput.files[0]);
                        formData.append('name', username);
                        modalUploadStatus.textContent = 'Uploading...';
                        try {
                            const response = await fetch('/api/upload-image', {
                                method: 'POST',
                                body: formData
                            });
                            if (response.ok) {
                                modalUploadStatus.textContent = 'Image uploaded successfully!';
                                showToast('Image uploaded successfully!');
                                setTimeout(() => {
                                    uploadModal.style.display = 'none';
                                }, 1200);
                            } else {
                                modalUploadStatus.textContent = 'Failed to upload image.';
                            }
                        } catch (error) {
                            modalUploadStatus.textContent = 'Error uploading image.';
                        }
                    } else {
                        modalUploadStatus.textContent = 'Please select an image.';
                    }
                });
            }
        });

        // Function to get user's location
        async function getUserLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation is not supported by your browser'));
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve({
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        });
                    },
                    (error) => {
                        reject(error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            });
        }

        // Gallery data
        const galleryData = [
            {
                id: "project-showcase-1",
                title: "Project Showcase 1",
                description: "A beautiful landscape showcasing our latest project in the mountains. This project demonstrates our commitment to sustainable development.",
                date: "March 15, 2024",
                image: "https://picsum.photos/800/600?random=1"
            },
            {
                id: "team-collaboration",
                title: "Team Collaboration",
                description: "Our team working together on an innovative solution. This photo captures the essence of our collaborative work environment.",
                date: "March 10, 2024",
                image: "https://picsum.photos/800/600?random=2"
            },
            {
                id: "office-environment",
                title: "Office Environment",
                description: "Our modern office space designed to foster creativity and productivity. This is where the magic happens!",
                date: "March 5, 2024",
                image: "https://picsum.photos/800/600?random=3"
            }
        ];

        // Function to open gallery modal
        function openGalleryModal(index) {
            const modal = document.getElementById('galleryModal');
            const data = galleryData[index];
            
            document.getElementById('modalImage').src = data.image;
            document.getElementById('modalTitle').textContent = data.title;
            document.getElementById('modalDescription').textContent = data.description;
            document.getElementById('modalDate').textContent = data.date;
            
            modal.style.display = 'flex';
            trackTap('View Gallery Image', { imageId: data.id, imageTitle: data.title });
        }

        // Function to close gallery modal
        function closeGalleryModal() {
            document.getElementById('galleryModal').style.display = 'none';
        }

        // Close modal when clicking outside
        document.getElementById('galleryModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeGalleryModal();
            }
        });

        // Function to track tap events
        async function trackTap(action, metadata = {}) {
            try {
                const location = await getUserLocation();
                fetch('/api/track-tap', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action,
                        metadata,
                        location: {
                            latitude: location.latitude,
                            longitude: location.longitude,
                            accuracy: location.accuracy
                        }
                    })
                }).catch(err => console.error('Tap tracking failed:', err));
            } catch (error) {
                console.error('Error getting location:', error);
                // Still track the tap even if location fails
                fetch('/api/track-tap', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action,
                        metadata
                    })
                }).catch(err => console.error('Tap tracking failed:', err));
            }
        }
    </script>
</body>
</html> 